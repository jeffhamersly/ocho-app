function S4(){return(65536*(1+Math.random())|0).toString(16).substring(1)}function guid(){return S4()+S4()+"-"+S4()+"-"+S4()+"-"+S4()+"-"+S4()+S4()+S4()}function Migrator(t,o){this.db=o,this.dbname=t.adapter.db_name,this.table=t.adapter.collection_name,this.idAttribute=t.adapter.idAttribute,this.column=function(t){var o=t.split(/\s+/),e=o[0];switch(e.toLowerCase()){case"string":case"varchar":case"date":case"datetime":Ti.API.warn('"'+e+'" is not a valid sqlite field, using TEXT instead');case"text":e="TEXT";break;case"int":case"tinyint":case"smallint":case"bigint":case"boolean":Ti.API.warn('"'+e+'" is not a valid sqlite field, using INTEGER instead');case"integer":e="INTEGER";break;case"double":case"float":case"decimal":case"number":Ti.API.warn('"'+t+'" is not a valid sqlite field, using REAL instead');case"real":e="REAL";break;case"blob":e="BLOB";break;case"null":e="NULL";break;default:e="TEXT"}return o[0]=e,o.join(" ")},this.createTable=function(t){var o=[],e=!1;for(var i in t.columns)i===this.idAttribute&&(e=!0),o.push(i+" "+this.column(t.columns[i]));e||this.idAttribute!==ALLOY_ID_DEFAULT||o.push(ALLOY_ID_DEFAULT+" TEXT UNIQUE");var n="CREATE TABLE IF NOT EXISTS "+this.table+" ( "+o.join(",")+")";this.db.execute(n)},this.dropTable=function(){this.db.execute("DROP TABLE IF EXISTS "+this.table)},this.insertRow=function(t){var o=[],e=[],i=[],n=!1;for(var r in t)r===this.idAttribute&&(n=!0),o.push(r),e.push(t[r]),i.push("?");n||this.idAttribute!==ALLOY_ID_DEFAULT||(o.push(this.idAttribute),e.push(guid()),i.push("?")),this.db.execute("INSERT INTO "+this.table+" ("+o.join(",")+") VALUES ("+i.join(",")+");",e)},this.deleteRow=function(t){var o="DELETE FROM "+this.table,e=_.keys(t),i=e.length,n=[],r=[];i&&(o+=" WHERE ");for(var a=0;i>a;a++)n.push(e[a]+" = ?"),r.push(t[e[a]]);o+=n.join(" AND "),this.db.execute(o,r)}}function Sync(t,o,e){var i,n,r=o.config.adapter.collection_name,a=o.config.columns,s=o.config.adapter.db_name||ALLOY_DB_DEFAULT,l=null;switch(t){case"create":case"update":l=function(){var t={};o.id||(o.id=o.idAttribute===ALLOY_ID_DEFAULT?guid():null,t[o.idAttribute]=o.id,"0.9.2"===backbone.VERSION?o.set(t,{silent:!0}):o.set(t));var e=[],l=[],u=[];for(var c in a)e.push(c),l.push(o.get(c)),u.push("?");return n="REPLACE INTO "+r+" ("+e.join(",")+") VALUES ("+u.join(",")+");",i=Ti.Database.open(s),i.execute(n,l),null===o.id&&(o.id=i.lastInsertRowId,t[o.idAttribute]=o.id,"0.9.2"===backbone.VERSION?o.set(t,{silent:!0}):o.set(t)),i.close(),o.toJSON()}();break;case"read":e.query&&e.id&&Ti.API.warn('Both "query" and "id" options were specified for model.fetch(). "id" will be ignored.'),n="SELECT * FROM "+r,e.query?n=e.query:e.id&&(n+=" WHERE "+(o.idAttribute?o.idAttribute:ALLOY_ID_DEFAULT)+" = "+(_.isString(e.id)?'"'+e.id+'"':e.id)),i=Ti.Database.open(s);var u;u=_.isString(n)?i.execute(n):i.execute(n.statement,n.params);for(var c=[],f=[],d=_.isFunction(u.fieldCount)?u.fieldCount():u.fieldCount,h=u.field,x=0;d>x;x++)f.push(u.fieldName(x));for(;u.isValidRow();){var C={};for(x=0;d>x;x++)C[f[x]]=h(x);c.push(C),u.next()}u.close(),i.close();var g=c.length;"0.9.2"===backbone.VERSION&&(o.length=g),l=1===g?c[0]:c;break;case"delete":n="DELETE FROM "+r+" WHERE "+o.idAttribute+"=?",i=Ti.Database.open(s),i.execute(n,o.id),i.close(),l=o.toJSON()}l?(_.isFunction(e.success)&&e.success(l),"read"!==t||e.silent||o.trigger("fetch",{fromAdapter:!0})):_.isFunction(e.error)&&e.error(l)}function GetMigrationFor(t,o){var e=null,i=Ti.Database.open(t);i.execute("CREATE TABLE IF NOT EXISTS migrations (latest TEXT, model TEXT);");var n=i.execute("SELECT latest FROM migrations where model = ?;",o);return n.isValidRow()&&(e=n.field(0)+""),n.close(),i.close(),e}function Migrate(t){var o=t.migrations||[],e={};o.length&&o[o.length-1](e);var i=t.prototype.config;i.adapter.db_name=i.adapter.db_name||ALLOY_DB_DEFAULT;var n=new Migrator(i),r="undefined"==typeof i.adapter.migration||null===i.adapter.migration?e.id:i.adapter.migration;if("undefined"==typeof r||null===r){var a=Ti.Database.open(i.adapter.db_name);return n.db=a,n.createTable(i),void a.close()}r+="";var s,l=GetMigrationFor(i.adapter.db_name,i.adapter.collection_name);if(l!==r){if(l&&l>r?(s=0,o.reverse()):s=1,db=Ti.Database.open(i.adapter.db_name),n.db=db,db.execute("BEGIN;"),o.length)for(var u=0;u<o.length;u++){var c=o[u],f={};if(c(f),s){if(f.id>r)break;if(f.id<=l)continue}else{if(f.id<=r)break;if(f.id>l)continue}var d=s?"up":"down";_.isFunction(f[d])&&f[d](n)}else n.createTable(i);db.execute("DELETE FROM migrations where model = ?",i.adapter.collection_name),db.execute("INSERT INTO migrations VALUES (?,?)",r,i.adapter.collection_name),db.execute("COMMIT;"),db.close(),n.db=null}}function installDatabase(t){var o=t.adapter.db_file,e=t.adapter.collection_name,i=/(^|.*\/)([^\/]+)\.[^\/]+$/,n=o.match(i);if(null===n)throw'Invalid sql database filename "'+o+'"';t.adapter.db_name=t.adapter.db_name||n[2];var r=t.adapter.db_name;Ti.API.debug('Installing sql database "'+o+'" with name "'+r+'"');var a=Ti.Database.install(o,r);!1===t.adapter.remoteBackup&&(Ti.API.debug('iCloud "do not backup" flag set for database "'+o+'"'),a.file.setRemoteBackup(!1));var s,l,u=a.execute('pragma table_info("'+e+'");'),c={};if(u){for(;u.isValidRow();)s=u.fieldByName("name"),l=u.fieldByName("type"),c[s]=l,s!==ALLOY_ID_DEFAULT||t.adapter.idAttribute||(t.adapter.idAttribute=ALLOY_ID_DEFAULT),u.next();u.close()}else{t.adapter.idAttribute?t.adapter.idAttribute:ALLOY_ID_DEFAULT;for(var f in t.columns)s=f,l=t.columns[f],s!==ALLOY_ID_DEFAULT||t.adapter.idAttribute?f===t.adapter.idAttribute&&(l+=" UNIQUE"):t.adapter.idAttribute=ALLOY_ID_DEFAULT,c[s]=l}if(t.columns=c,t.adapter.idAttribute){if(!_.contains(_.keys(t.columns),t.adapter.idAttribute))throw'config.adapter.idAttribute "'+t.adapter.idAttribute+'" not found in list of columns for table "'+e+'"\ncolumns: ['+_.keys(t.columns).join(",")+"]"}else{Ti.API.info('No config.adapter.idAttribute specified for table "'+e+'"'),Ti.API.info('Adding "'+ALLOY_ID_DEFAULT+'" to uniquely identify rows');var d=[],h=[];_.each(t.columns,function(t,o){h.push(o),d.push(o+" "+t)});var x=h.join(",");a.execute("ALTER TABLE "+e+" RENAME TO "+e+"_temp;"),a.execute("CREATE TABLE "+e+"("+d.join(",")+","+ALLOY_ID_DEFAULT+" TEXT UNIQUE);"),a.execute("INSERT INTO "+e+"("+x+","+ALLOY_ID_DEFAULT+") SELECT "+x+",CAST(_ROWID_ AS TEXT) FROM "+e+"_temp;"),a.execute("DROP TABLE "+e+"_temp;"),t.columns[ALLOY_ID_DEFAULT]="TEXT UNIQUE",t.adapter.idAttribute=ALLOY_ID_DEFAULT}a.close()}var _=require("alloy/underscore")._,backbone=require("alloy/backbone"),ALLOY_DB_DEFAULT="_alloy_",ALLOY_ID_DEFAULT="alloy_id",cache={config:{},Model:{}};module.exports.beforeModelCreate=function(t,o){if(cache.config[o])return cache.config[o];if("mobileweb"===Ti.Platform.osname||"undefined"==typeof Ti.Database)throw"No support for Titanium.Database in MobileWeb environment.";return t.adapter.db_file&&installDatabase(t),t.adapter.idAttribute||(Ti.API.info('No config.adapter.idAttribute specified for table "'+t.adapter.collection_name+'"'),Ti.API.info('Adding "'+ALLOY_ID_DEFAULT+'" to uniquely identify rows'),t.columns[ALLOY_ID_DEFAULT]="TEXT UNIQUE",t.adapter.idAttribute=ALLOY_ID_DEFAULT),cache.config[o]=t,t},module.exports.afterModelCreate=function(t,o){return cache.Model[o]?cache.Model[o]:(t=t||{},t.prototype.idAttribute=t.prototype.config.adapter.idAttribute,Migrate(t),cache.Model[o]=t,t)},module.exports.sync=Sync;