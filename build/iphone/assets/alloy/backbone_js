(function(){var t,o=this,i=o.Backbone,n=Array.prototype.slice,e=Array.prototype.splice;t="undefined"!=typeof exports?exports:o.Backbone={},t.VERSION="0.9.2";var s=o._;s||"undefined"==typeof require||(s=require("alloy/underscore"));var a=o.jQuery||o.Zepto||o.ender;t.setDomLibrary=function(t){a=t},t.noConflict=function(){return o.Backbone=i,this},t.emulateHTTP=!1,t.emulateJSON=!1;var r=/\s+/,l=t.Events={on:function(t,o,i){var n,e,s,a,l;if(!o)return this;for(t=t.split(r),n=this._callbacks||(this._callbacks={});e=t.shift();)l=n[e],s=l?l.tail:{},s.next=a={},s.context=i,s.callback=o,n[e]={tail:a,next:l?l.next:s};return this},off:function(t,o,i){var n,e,a,l,u,C;if(e=this._callbacks){if(!(t||o||i))return delete this._callbacks,this;for(t=t?t.split(r):s.keys(e);n=t.shift();)if(a=e[n],delete e[n],a&&(o||i))for(l=a.tail;(a=a.next)!==l;)u=a.callback,C=a.context,(o&&u!==o||i&&C!==i)&&this.on(n,u,C);return this}},trigger:function(t){var o,i,e,s,a,l,u;if(!(e=this._callbacks))return this;for(l=e.all,t=t.split(r),u=n.call(arguments,1);o=t.shift();){if(i=e[o])for(s=i.tail;(i=i.next)!==s;)i.callback.apply(i.context||this,u);if(i=l)for(s=i.tail,a=[o].concat(u);(i=i.next)!==s;)i.callback.apply(i.context||this,a)}return this}};l.bind=l.on,l.unbind=l.off;var u=t.Model=function(t,o){var i;t||(t={}),o&&o.parse&&(t=this.parse(t)),(i=b(this,"defaults"))&&(t=s.extend({},i,t)),o&&o.collection&&(this.collection=o.collection),this.attributes={},this._escapedAttributes={},this.cid=s.uniqueId("c"),this.changed={},this._silent={},this._pending={},this.set(t,{silent:!0}),this.changed={},this._silent={},this._pending={},this._previousAttributes=s.clone(this.attributes),this.initialize.apply(this,arguments)};s.extend(u.prototype,l,{changed:null,_silent:null,_pending:null,idAttribute:"id",initialize:function(){},toJSON:function(){return s.clone(this.attributes)},get:function(t){return this.attributes[t]},escape:function(t){var o;if(o=this._escapedAttributes[t])return o;var i=this.get(t);return this._escapedAttributes[t]=s.escape(null==i?"":""+i)},has:function(t){return null!=this.get(t)},set:function(t,o,i){var n,e,a;if(s.isObject(t)||null==t?(n=t,i=o):(n={},n[t]=o),i||(i={}),!n)return this;if(n instanceof u&&(n=n.attributes),i.unset)for(e in n)n[e]=void 0;if(!this._validate(n,i))return!1;this.idAttribute in n&&(this.id=n[this.idAttribute]);var r=i.changes={},l=this.attributes,C=this._escapedAttributes,x=this._previousAttributes||{};for(e in n)a=n[e],(!s.isEqual(l[e],a)||i.unset&&s.has(l,e))&&(delete C[e],(i.silent?this._silent:r)[e]=!0),i.unset?delete l[e]:l[e]=a,s.isEqual(x[e],a)&&s.has(l,e)==s.has(x,e)?(delete this.changed[e],delete this._pending[e]):(this.changed[e]=a,i.silent||(this._pending[e]=!0));return i.silent||this.change(i),this},unset:function(t,o){return(o||(o={})).unset=!0,this.set(t,null,o)},clear:function(t){return(t||(t={})).unset=!0,this.set(s.clone(this.attributes),t)},fetch:function(o){o=o?s.clone(o):{};var i=this,n=o.success;return o.success=function(t,e,s){return i.set(i.parse(t,s),o)?void(n&&n(i,t)):!1},o.error=t.wrapError(o.error,i,o),(this.sync||t.sync).call(this,"read",this,o)},save:function(o,i,n){var e,a;if(s.isObject(o)||null==o?(e=o,n=i):(e={},e[o]=i),n=n?s.clone(n):{},n.wait){if(!this._validate(e,n))return!1;a=s.clone(this.attributes)}var r=s.extend({},n,{silent:!0});if(e&&!this.set(e,n.wait?r:n))return!1;var l=this,u=n.success;n.success=function(t,o,i){var a=l.parse(t,i);return n.wait&&(delete n.wait,a=s.extend(e||{},a)),l.set(a,n)?void(u?u(l,t):l.trigger("sync",l,t,n)):!1},n.error=t.wrapError(n.error,l,n);var C=this.isNew()?"create":"update",x=(this.sync||t.sync).call(this,C,this,n);return n.wait&&this.set(a,r),x},destroy:function(o){o=o?s.clone(o):{};var i=this,n=o.success,e=function(){i.trigger("destroy",i,i.collection,o)};if(this.isNew())return e(),!1;o.success=function(t){o.wait&&e(),n?n(i,t):i.trigger("sync",i,t,o)},o.error=t.wrapError(o.error,i,o);var a=(this.sync||t.sync).call(this,"delete",this,o);return o.wait||e(),a},url:function(){var t=b(this,"urlRoot")||b(this.collection,"url")||U();return this.isNew()?t:t+("/"==t.charAt(t.length-1)?"":"/")+encodeURIComponent(this.id)},parse:function(t){return t},clone:function(){return new this.constructor(this.attributes)},isNew:function(){return null==this.id},change:function(t){t||(t={});var o=this._changing;this._changing=!0;for(var i in this._silent)this._pending[i]=!0;var n=s.extend({},t.changes,this._silent);this._silent={};for(var i in n)this.trigger("change:"+i,this,this.get(i),t);if(o)return this;for(;!s.isEmpty(this._pending);){this._pending={},this.trigger("change",this,t);for(var i in this.changed)this._pending[i]||this._silent[i]||delete this.changed[i];this._previousAttributes=s.clone(this.attributes)}return this._changing=!1,this},hasChanged:function(t){return arguments.length?s.has(this.changed,t):!s.isEmpty(this.changed)},changedAttributes:function(t){if(!t)return this.hasChanged()?s.clone(this.changed):!1;var o,i=!1,n=this._previousAttributes;for(var e in t)s.isEqual(n[e],o=t[e])||((i||(i={}))[e]=o);return i},previous:function(t){return arguments.length&&this._previousAttributes?this._previousAttributes[t]:null},previousAttributes:function(){return s.clone(this._previousAttributes)},isValid:function(){return!this.validate(this.attributes)},_validate:function(t,o){if(o.silent||!this.validate)return!0;t=s.extend({},this.attributes,t);var i=this.validate(t,o);return i?(o&&o.error?o.error(this,i,o):this.trigger("error",this,i,o),!1):!0}});var C=t.Collection=function(t,o){o||(o={}),o.model&&(this.model=o.model),o.comparator&&(this.comparator=o.comparator),this._reset(),this.initialize.apply(this,arguments),t&&this.reset(t,{silent:!0,parse:o.parse})};s.extend(C.prototype,l,{model:u,initialize:function(){},toJSON:function(t){return this.map(function(o){return o.toJSON(t)})},add:function(t,o){var i,n,a,r,l,u,C={},x={},h=[];for(o||(o={}),t=s.isArray(t)?t.slice():[t],i=0,a=t.length;a>i;i++){if(!(r=t[i]=this._prepareModel(t[i],o)))throw new Error("Can't add an invalid model to a collection");l=r.cid,u=r.id,C[l]||this._byCid[l]||null!=u&&(x[u]||this._byId[u])?h.push(i):C[l]=x[u]=r}for(i=h.length;i--;)t.splice(h[i],1);for(i=0,a=t.length;a>i;i++)(r=t[i]).on("all",this._onModelEvent,this),this._byCid[r.cid]=r,null!=r.id&&(this._byId[r.id]=r);if(this.length+=a,n=null!=o.at?o.at:this.models.length,e.apply(this.models,[n,0].concat(t)),this.comparator&&this.sort({silent:!0}),o.silent)return this;for(i=0,a=this.models.length;a>i;i++)C[(r=this.models[i]).cid]&&(o.index=i,r.trigger("add",r,this,o));return this},remove:function(t,o){var i,n,e,a;for(o||(o={}),t=s.isArray(t)?t.slice():[t],i=0,n=t.length;n>i;i++)a=this.getByCid(t[i])||this.get(t[i]),a&&(delete this._byId[a.id],delete this._byCid[a.cid],e=this.indexOf(a),this.models.splice(e,1),this.length--,o.silent||(o.index=e,a.trigger("remove",a,this,o)),this._removeReference(a));return this},push:function(t,o){return t=this._prepareModel(t,o),this.add(t,o),t},pop:function(t){var o=this.at(this.length-1);return this.remove(o,t),o},unshift:function(t,o){return t=this._prepareModel(t,o),this.add(t,s.extend({at:0},o)),t},shift:function(t){var o=this.at(0);return this.remove(o,t),o},get:function(t){return null==t?void 0:this._byId[null!=t.id?t.id:t]},getByCid:function(t){return t&&this._byCid[t.cid||t]},at:function(t){return this.models[t]},where:function(t){return s.isEmpty(t)?[]:this.filter(function(o){for(var i in t)if(t[i]!==o.get(i))return!1;return!0})},sort:function(t){if(t||(t={}),!this.comparator)throw new Error("Cannot sort a set without a comparator");var o=s.bind(this.comparator,this);return 1==this.comparator.length?this.models=this.sortBy(o):this.models.sort(o),t.silent||this.trigger("reset",this,t),this},pluck:function(t){return s.map(this.models,function(o){return o.get(t)})},reset:function(t,o){t||(t=[]),o||(o={});for(var i=0,n=this.models.length;n>i;i++)this._removeReference(this.models[i]);return this._reset(),this.add(t,s.extend({silent:!0},o)),o.silent||this.trigger("reset",this,o),this},fetch:function(o){o=o?s.clone(o):{},void 0===o.parse&&(o.parse=!0);var i=this,n=o.success;return o.success=function(t,e,s){i[o.add?"add":"reset"](i.parse(t,s),o),n&&n(i,t)},o.error=t.wrapError(o.error,i,o),(this.sync||t.sync).call(this,"read",this,o)},create:function(t,o){var i=this;if(o=o?s.clone(o):{},t=this._prepareModel(t,o),!t)return!1;o.wait||i.add(t,o);var n=o.success;return o.success=function(e,s){o.wait&&i.add(e,o),n?n(e,s):e.trigger("sync",t,s,o)},t.save(null,o),t},parse:function(t){return t},chain:function(){return s(this.models).chain()},_reset:function(){this.length=0,this.models=[],this._byId={},this._byCid={}},_prepareModel:function(t,o){if(o||(o={}),t instanceof u)t.collection||(t.collection=this);else{var i=t;o.collection=this,t=new this.model(i,o),t._validate(t.attributes,o)||(t=!1)}return t},_removeReference:function(t){this==t.collection&&delete t.collection,t.off("all",this._onModelEvent,this)},_onModelEvent:function(t,o,i,n){("add"!=t&&"remove"!=t||i==this)&&("destroy"==t&&this.remove(o,n),o&&t==="change:"+o.idAttribute&&(delete this._byId[o.previous(o.idAttribute)],this._byId[o.id]=o),this.trigger.apply(this,arguments))}});var x=["forEach","each","map","reduce","reduceRight","find","detect","filter","select","reject","every","all","some","any","include","contains","invoke","max","min","sortBy","sortedIndex","toArray","size","first","initial","rest","last","without","indexOf","shuffle","lastIndexOf","isEmpty","groupBy"];s.each(x,function(t){C.prototype[t]=function(){return s[t].apply(s,[this.models].concat(s.toArray(arguments)))}});var h=t.Router=function(t){t||(t={}),t.routes&&(this.routes=t.routes),this._bindRoutes(),this.initialize.apply(this,arguments)},f=/:\w+/g,g=/\*\w+/g,c=/[-[\]{}()+?.,\\^$|#\s]/g;s.extend(h.prototype,l,{initialize:function(){},route:function(o,i,n){return t.history||(t.history=new m),s.isRegExp(o)||(o=this._routeToRegExp(o)),n||(n=this[i]),t.history.route(o,s.bind(function(e){var s=this._extractParameters(o,e);n&&n.apply(this,s),this.trigger.apply(this,["route:"+i].concat(s)),t.history.trigger("route",this,i,s)},this)),this},navigate:function(o,i){t.history.navigate(o,i)},_bindRoutes:function(){if(this.routes){var t=[];for(var o in this.routes)t.unshift([o,this.routes[o]]);for(var i=0,n=t.length;n>i;i++)this.route(t[i][0],t[i][1],this[t[i][1]])}},_routeToRegExp:function(t){return t=t.replace(c,"\\$&").replace(f,"([^/]+)").replace(g,"(.*?)"),new RegExp("^"+t+"$")},_extractParameters:function(t,o){return t.exec(o).slice(1)}});var m=t.History=function(){this.handlers=[],s.bindAll(this,"checkUrl")},d=/^[#\/]/,N=/msie [\w.]+/;m.started=!1,s.extend(m.prototype,l,{interval:50,getHash:function(t){var o=t?t.location:window.location,i=o.href.match(/#(.*)$/);return i?i[1]:""},getFragment:function(t,o){if(null==t)if(this._hasPushState||o){t=window.location.pathname;var i=window.location.search;i&&(t+=i)}else t=this.getHash();return t.indexOf(this.options.root)||(t=t.substr(this.options.root.length)),t.replace(d,"")},start:function(t){if(m.started)throw new Error("Backbone.history has already been started");m.started=!0,this.options=s.extend({},{root:"/"},this.options,t),this._wantsHashChange=this.options.hashChange!==!1,this._wantsPushState=!!this.options.pushState,this._hasPushState=!!(this.options.pushState&&window.history&&window.history.pushState);var o=this.getFragment(),i=document.documentMode,n=N.exec(navigator.userAgent.toLowerCase())&&(!i||7>=i);n&&(this.iframe=a('<iframe src="javascript:0" tabindex="-1" />').hide().appendTo("body")[0].contentWindow,this.navigate(o)),this._hasPushState?a(window).bind("popstate",this.checkUrl):this._wantsHashChange&&"onhashchange"in window&&!n?a(window).bind("hashchange",this.checkUrl):this._wantsHashChange&&(this._checkUrlInterval=setInterval(this.checkUrl,this.interval)),this.fragment=o;var e=window.location,r=e.pathname==this.options.root;return this._wantsHashChange&&this._wantsPushState&&!this._hasPushState&&!r?(this.fragment=this.getFragment(null,!0),window.location.replace(this.options.root+"#"+this.fragment),!0):(this._wantsPushState&&this._hasPushState&&r&&e.hash&&(this.fragment=this.getHash().replace(d,""),window.history.replaceState({},document.title,e.protocol+"//"+e.host+this.options.root+this.fragment)),this.options.silent?void 0:this.loadUrl())},stop:function(){a(window).unbind("popstate",this.checkUrl).unbind("hashchange",this.checkUrl),clearInterval(this._checkUrlInterval),m.started=!1},route:function(t,o){this.handlers.unshift({route:t,callback:o})},checkUrl:function(){var t=this.getFragment();return t==this.fragment&&this.iframe&&(t=this.getFragment(this.getHash(this.iframe))),t==this.fragment?!1:(this.iframe&&this.navigate(t),void(this.loadUrl()||this.loadUrl(this.getHash())))},loadUrl:function(t){var o=this.fragment=this.getFragment(t),i=s.any(this.handlers,function(t){return t.route.test(o)?(t.callback(o),!0):void 0});return i},navigate:function(t,o){if(!m.started)return!1;o&&o!==!0||(o={trigger:o});var i=(t||"").replace(d,"");this.fragment!=i&&(this._hasPushState?(0!=i.indexOf(this.options.root)&&(i=this.options.root+i),this.fragment=i,window.history[o.replace?"replaceState":"pushState"]({},document.title,i)):this._wantsHashChange?(this.fragment=i,this._updateHash(window.location,i,o.replace),this.iframe&&i!=this.getFragment(this.getHash(this.iframe))&&(o.replace||this.iframe.document.open().close(),this._updateHash(this.iframe.location,i,o.replace))):window.location.assign(this.options.root+t),o.trigger&&this.loadUrl(t))},_updateHash:function(t,o,i){i?t.replace(t.toString().replace(/(javascript:|#).*$/,"")+"#"+o):t.hash=o}});var p=t.View=function(t){this.cid=s.uniqueId("view"),this._configure(t||{}),this._ensureElement(),this.initialize.apply(this,arguments),this.delegateEvents()},S=/^(\S+)\s*(.*)$/,y=["model","collection","el","id","attributes","className","tagName"];s.extend(p.prototype,l,{tagName:"div",$:function(t){return this.$el.find(t)},initialize:function(){},render:function(){return this},remove:function(){return this.$el.remove(),this},make:function(t,o,i){var n=document.createElement(t);return o&&a(n).attr(o),i&&a(n).html(i),n},setElement:function(t,o){return this.$el&&this.undelegateEvents(),this.$el=t instanceof a?t:a(t),this.el=this.$el[0],o!==!1&&this.delegateEvents(),this},delegateEvents:function(t){if(t||(t=b(this,"events"))){this.undelegateEvents();for(var o in t){var i=t[o];if(s.isFunction(i)||(i=this[t[o]]),!i)throw new Error('Method "'+t[o]+'" does not exist');var n=o.match(S),e=n[1],a=n[2];i=s.bind(i,this),e+=".delegateEvents"+this.cid,""===a?this.$el.bind(e,i):this.$el.delegate(a,e,i)}}},undelegateEvents:function(){this.$el.unbind(".delegateEvents"+this.cid)},_configure:function(t){this.options&&(t=s.extend({},this.options,t));for(var o=0,i=y.length;i>o;o++){var n=y[o];t[n]&&(this[n]=t[n])}this.options=t},_ensureElement:function(){if(this.el)this.setElement(this.el,!1);else{var t=b(this,"attributes")||{};this.id&&(t.id=this.id),this.className&&(t["class"]=this.className),this.setElement(this.make(this.tagName,t),!1)}}});var v=function(t,o){var i=k(this,t,o);return i.extend=this.extend,i};u.extend=C.extend=h.extend=p.extend=v;var A={create:"POST",update:"PUT","delete":"DELETE",read:"GET"};t.sync=function(o,i,n){var e=A[o];n||(n={});var r={type:e,dataType:"json"};return n.url||(r.url=b(i,"url")||U()),n.data||!i||"create"!=o&&"update"!=o||(r.contentType="application/json",r.data=JSON.stringify(i.toJSON())),t.emulateJSON&&(r.contentType="application/x-www-form-urlencoded",r.data=r.data?{model:r.data}:{}),t.emulateHTTP&&("PUT"===e||"DELETE"===e)&&(t.emulateJSON&&(r.data._method=e),r.type="POST",r.beforeSend=function(t){t.setRequestHeader("X-HTTP-Method-Override",e)}),"GET"===r.type||t.emulateJSON||(r.processData=!1),a.ajax(s.extend(r,n))},t.wrapError=function(t,o,i){return function(n,e){e=n===o?e:n,t?t(o,e,i):o.trigger("error",o,e,i)}};var L=function(){},k=function(t,o,i){var n;return n=o&&o.hasOwnProperty("constructor")?o.constructor:function(){t.apply(this,arguments)},s.extend(n,t),L.prototype=t.prototype,n.prototype=new L,o&&s.extend(n.prototype,o),i&&s.extend(n,i),n.prototype.constructor=n,n.__super__=t.prototype,n},b=function(t,o){return t&&t[o]?s.isFunction(t[o])?t[o]():t[o]:null},U=function(){throw new Error('A "url" property or function must be specified')}}).call(this);