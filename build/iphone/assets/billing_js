function showLoading(){loadingCount+=1,1==loadingCount&&loading.show()}function hideLoading(){loadingCount>0&&(loadingCount-=1,0==loadingCount&&loading.hide())}function isIOS7Plus(){var e=Titanium.Platform.version.split("."),t=parseInt(e[0],10);return t>=7?!0:!1}function markProductAsPurchased(e){Ti.API.info("Marking as purchased: "+e),tempPurchasedStore[e]=!0,Ti.App.Properties.setBool("Purchased-"+e,!0)}function checkIfProductPurchased(e){return Ti.API.info("Checking if purchased: "+e),void 0===tempPurchasedStore[e]&&(tempPurchasedStore[e]=Ti.App.Properties.getBool("Purchased-"+e,!1)),tempPurchasedStore[e]}function requestProduct(e,t){showLoading(),Storekit.requestProducts([e],function(e){hideLoading(),e.success?e.invalid?alert("ERROR: We requested an invalid product!"):t(e.products[0]):alert("ERROR: We failed to talk to Apple!")})}function purchaseProduct(e){e.downloadable&&Ti.API.info("Purchasing a product that is downloadable"),showLoading(),Storekit.purchase({product:e})}function restorePurchases(){showLoading(),Storekit.restoreCompletedTransactions()}exports.makePurchase=function(e){Storekit.addTransactionObserver(),IOS7&&win.addEventListener("open",function(){}),Storekit.canMakePayments?requestProduct(e,function(e){purchaseProduct(e)}):alert("This device cannot make purchases!")},exports.checkPurchase=function(e){return Storekit.canMakePayments?checkIfProductPurchased(e):void alert("This device cannot make purchases!")};var Storekit=require("ti.storekit");Storekit.autoFinishTransactions=!0,Storekit.bundleVersion="1.0.0",Storekit.bundleIdentifier="com.lotteryegg.lotteryegg";var verifyingReceipts=!1,win=Ti.UI.createWindow({backgroundColor:"#fff"}),loading=Ti.UI.createActivityIndicator({bottom:10,height:50,width:50,backgroundColor:"black",borderRadius:10,style:Ti.UI.iPhone.ActivityIndicatorStyle.BIG}),loadingCount=0;win.add(loading);var tempPurchasedStore={},IOS7=isIOS7Plus();Storekit.addEventListener("transactionState",function(e){switch(hideLoading(),e.state){case Storekit.TRANSACTION_STATE_FAILED:alert(e.cancelled?"Purchase cancelled":"ERROR: Buying failed! "+e.message),e.transaction&&e.transaction.finish();break;case Storekit.TRANSACTION_STATE_PURCHASED:if(verifyingReceipts)if(IOS7){var t=Storekit.validateReceipt()?"Receipt is Valid!":"Receipt is Invalid.";alert(t)}else Storekit.verifyReceipt(e,function(t){t.success?t.valid?(alert("Thanks! Receipt Verified"),markProductAsPurchased(e.productIdentifier)):alert("Sorry. Receipt is invalid"):alert(t.message)});else markProductAsPurchased(e.productIdentifier),Alloy.Globals.settings.close();e.downloads?Storekit.startDownloads({downloads:e.downloads}):e.transaction&&e.transaction.finish();break;case Storekit.TRANSACTION_STATE_PURCHASING:Ti.API.info("Purchasing "+e.productIdentifier);break;case Storekit.TRANSACTION_STATE_RESTORED:Ti.API.info("Restored "+e.productIdentifier),e.downloads&&Ti.API.info("Downloads available for restored product"),e.transaction&&e.transaction.finish()}}),Storekit.addEventListener("restoredCompletedTransactions",function(e){if(hideLoading(),e.error)alert(e.error);else if(null==e.transactions||0==e.transactions.length)alert("There were no purchases to restore!");else{IOS7&&verifyingReceipts&&(Storekit.validateReceipt()?Ti.API.info("Restored Receipt is Valid!"):Ti.API.error("Restored Receipt is Invalid."));for(var t=0;t<e.transactions.length;t++)!IOS7&&verifyingReceipts?Storekit.verifyReceipt(e.transactions[t],function(e){e.valid?markProductAsPurchased(e.productIdentifier):Ti.API.error("Restored transaction is not valid")}):markProductAsPurchased(e.transactions[t].productIdentifier);alert("Restored "+e.transactions.length+" purchases!")}});